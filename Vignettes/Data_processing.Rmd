---
title: "Data_processing"
author: "Chiara Huwiler"
date: "2023-11-30"
output: html_document
---

### Setting up

```{r, eval=FALSE}
# Set up
install.packages("rgbif")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("tidyr")
install.packages("stringr")
install.packages("lubridate")
install.packages("countrycode")
install.packages("rnaturalearth")
install.packages("rnaturalearthdata")
install.packages("RColorBrewer")
install.packages("magick")
install.packages("viridis")
devtools::install_version("gganimate", version = "1.0.7")
devtools::install_version("transformr", version = "0.1.3")
install.packages("sf")
```

```{r = evalse}
# Load packages
library(rgbif)
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
library(lubridate)
library(countrycode)
library(rnaturalearth)
library(rnaturalearthdata)
library(RColorBrewer)
library(magick)
library(gganimate)
library(transformr)
library(sf)
```

### Finding earliest apperance

The country codes are based on the ISO-alpha3 code iso 3166-1 alpha-2 standard and are listed by continents according the Geographic Regions data of the [United Nations](https://unstats.un.org/unsd/methodology/m49/).

Region Codes

-   Asia 142

-   Europe 150

-   South America 419

-   North America 021

-   Oceania 009

-   Africa 002

```{r}
combined_data <- read.csv("../Data_ingredients/cleaned/combined_data.csv")
UNSD_M49 <- read.csv("../Data/UNSD_M49.csv")

# Remove rows with NA in countryCode
combined_data_e <- combined_data[complete.cases(combined_data$countryCode), ]

# combined_data_e extended with Regions code from the UN

# Getting the data frame from a single column to a usable data frame
UNSD_M49_split <- separate(data = UNSD_M49,
                            col = Region_Code.Region.Name.Sub.region.Code.Sub.region.Name.ISO_alpha2_Code,
                            into = c("Region_Code", "Region_Name", "Subregion_Code", "Subregion_Name", "ISO_alpha2_Code"), sep = ";",
                            fill = "right", convert = TRUE)


# Find rows with missing values after separation
problematic_rows <- apply(UNSD_M49_split, 1, function(row) any(is.na(row)))

# Remove problematic rows from UNSD_M49_split
UNSD_M49_split <- UNSD_M49_split[complete.cases(UNSD_M49_split), ]

# Merging data frames
merged_data <- merge(combined_data_e, UNSD_M49_split, by.x = "countryCode", by.y = "ISO_alpha2_Code", all.x = TRUE)

# Check if "americas" is present in Region_Name, if true, use Subregion_Name
merged_data$Region_Name <- ifelse(merged_data$Region_Name == "Americas", merged_data$Subregion_Name, merged_data$Region_Name)

# Remove Subregion_Name column if it's no longer needed
merged_data <- merged_data[, !(names(merged_data) %in% c("Subregion_Name"))]

# Changing the UN Definition to the shorter "Southern America" 
merged_data$Region_Name <- ifelse(merged_data$Region_Name == "Latin America and the Caribbean", "South America", merged_data$Region_Name)

merged_data$Region_Name <- ifelse(merged_data$Region_Name == "Northern America", "North America", merged_data$Region_Name)

# Keeping only the needed columns
merged_data <- merged_data[, c("countryCode", "X", "scientificName", "year", "Region_Name")]

# For not considering all the subspecies the species are defined here

species_of_interest <- c("Triticum L.", "Olea europaea L.", "Zea mays L.", "Solanum lycopersicum L.", "Allium cepa L.", "Capsicum L.", "Ocimum basilicum L.")

# Remove rows with NA in Region_Name
filtered_data <- merged_data %>%
  filter(!is.na(Region_Name)) %>%
  filter(scientificName %in% species_of_interest)

# Save merged_data to the "Data" folder
write.csv(merged_data, file.path("../Data", "merged_data.csv"), row.names = FALSE)

# Save filtered_data to the "Data" folder
write.csv(filtered_data, file.path("../Data", "filtered_data.csv"), row.names = FALSE)

```

```{r}
# Create an empty list to store results for each species
result_list <- list()

# Loop over each species
for (species in species_of_interest) {
  # Filter data for the current species
  species_data <- filtered_data[filtered_data$scientificName == species, ]
  
  # Create an empty data frame to store results for each continent
  species_results <- data.frame()
  
  # Loop over each continent
  for (continent in unique(species_data$Region_Name)) {
    # Filter data for the current continent
    continent_data <- species_data[species_data$Region_Name == continent, ]
    
    # Find the earliest appearance year
    earliest_year <- min(continent_data$year, na.rm = TRUE)
    
    # Create a data frame with species, continent, and earliest year
    continent_result <- data.frame(
      species = species,
      continent = continent,
      earliest_year = earliest_year
    )
    
    # Append the result to the species_results data frame
    species_results <- rbind(species_results, continent_result)
  }
  
  # Append the results for the current species to the result_list
  result_list[[species]] <- species_results
  
  # Saving results to individual CSV files
  write.csv(species_results, file = paste0("../EAC_ingredients/EAC/", gsub(" ", "_", species), "_EAC.csv"), row.names = FALSE)
  
  # Print results for the current species
  print(species_results)
}
```

## Plotting the result

### And ordering the continents form earliest to latest appearance year.

-\> use line plot?

```{r}
# Creating an empty list to store plots for each species
plot_list <- list()

# Looping over species names
for (species_name in species_of_interest) {
    
    # Reading the corresponding EAC CSV file
    species_results <- read.csv(file.path("../EAC_ingredients/EAC/", paste0(gsub(" ", "_", species_name), "_EAC.csv")))
    
    # Ordering the data frame by EarliestYear in ascending order
    species_results <- species_results %>% arrange(earliest_year)
    
    # Getting the order of continents based on the first appearance year
    continent_order <- species_results %>%
        group_by(continent) %>%
        summarize(first_appearance = min(earliest_year)) %>%
        arrange(first_appearance) %>%
        pull(continent)
    
    # Defining custom order for y axis
    custom_order <- continent_order
    
    # Creating a factor variable for Continent with the custom order
    species_results$continent <- factor(species_results$continent, levels = custom_order)
    
    # Creating a timeline plot
    timeline_plot <- ggplot(species_results, aes(x = earliest_year, y = factor(continent, levels = custom_order))) +
        geom_segment(aes(xend = earliest_year, yend = factor(continent, levels = custom_order)), color = "skyblue") +
        geom_point(size = 3, color = "darkblue") +
        labs(title = paste("Timeline of Earliest Appearance of", species_name), x = "Year", y = "Continent") +
        theme_minimal()
    
    # Save the plot as a PNG file
    ggsave(paste0("../EAC_ingredients/timeline_plots/timeline_", gsub(" ", "_", species_name), ".png"), timeline_plot, width = 8, height = 6)
    
    # Print the plot for the current species
    print(timeline_plot)
}
```

```{r}
# Animating the plots


# Function to create an animated plot for a species
create_species_animation <- function(species_name) {
  # Reading the corresponding EAC CSV file
  species_result <- read.csv(file.path("../EAC_ingredients/EAC/", paste0(gsub(" ", "_", species_name), "_EAC.csv")))
  
  # Ordering the data frame by EarliestAppearance in ascending order
  species_result <- species_result %>% arrange(earliest_year)
  
  # Getting the order of continents based on the first appearance year
  continent_order <- species_result %>%
    group_by(continent) %>%
    summarize(first_appearance = min(earliest_year)) %>%
    arrange(first_appearance) %>%
    pull(continent)
  
  # Defining custom order for y-axis
  custom_order <- continent_order
  
  # Creating a factor variable for Continent with the custom order
  species_result$continent <- factor(species_result$continent, levels = custom_order)
  
  # Creating the animated plot
  animated_plot <- ggplot(species_result, aes(x = earliest_year, y = factor(continent, levels = custom_order))) +
    geom_segment(aes(xend = earliest_year, yend = factor(continent, levels = custom_order)), color = "skyblue") +
    geom_point(aes(color = continent), size = 3) +
    labs(title = paste("Timeline of Earliest Appearance of", species_name), x = "Year", y = "Continent", color = "Continent") +
    theme_minimal() +
    transition_states(earliest_year, transition_length = 2, state_length = 1)
  
  # Save the animation as a GIF file
  anim_save(paste0("../EAC_ingredients/animations/plots", gsub(" ", "_", species_name), "_animation.gif"), animate(animated_plot), width = 800, height = 600, duration = 10)
  
  # Print the animated plot for the current species
  print(animate(animated_plot))
}

# Looping over species names and create animations
lapply(species_of_interest, create_species_animation)

```

### Plotting the Data on a Map

Here UN Gegraphical Data is used for specifing the continents.

```{r}
# Loading world data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Standardizing continent names in world data
world <- world %>%
  mutate(region_un = case_when(
    region_un %in% c("Asia", "Oceania", "South America", "North America", "Africa", "Europe") ~ region_un,
    TRUE ~ "Other"
  ))

# Function to create a map plot for a species
create_species_map <- function(species_name) {
  # Reading the corresponding EAC CSV file
  species_result <- read.csv(file.path("../EAC_ingredients/EAC/", paste0(gsub(" ", "_", species_name), "_EAC.csv")))
  
  # Ordering the data frame by EarliestAppearance in ascending order
  species_result <- species_result %>% arrange(earliest_year)
  
  # Getting the order of continents based on the first appearance year
  continent_order <- species_result %>%
    group_by(continent) %>%
    summarize(first_appearance = min(earliest_year)) %>%
    arrange(first_appearance) %>%
    pull(continent)
  
  # Defining custom order for y-axis
  custom_order <- continent_order
  
  # Creating a factor variable for Continent with the custom order
  species_result$continent <- factor(species_result$continent, levels = custom_order)
  
  # Merging species_result data frame with continent boundaries
  merged_data <- merge(world, species_result, by.x = "continent", by.y = "continent")
  
  # Creating the map
  map_plot <- ggplot(merged_data) +
    geom_sf(aes(fill = factor(earliest_year))) +
    scale_fill_brewer(palette = 1) +
    labs(title = paste(species_name),
         fill = "Year of Earliest Appearance per continent") +
    theme_minimal() +
    theme(plot.background = element_rect(fill = "white")) +
          coord_sf(label_axes = "both")
  
  # Printing the map plot
  print(map_plot)
  
  # Creating a folder for each species
  species_folder <- paste0("../EAC_ingredients/maps/EAC_", gsub(" ", "_", gsub("\\.", "", species_name)), "/")
  dir.create(species_folder, showWarnings = FALSE)
  
  # Saving the map plot
  ggsave(paste0(species_folder, "earliest_appearance.png"), plot = map_plot, width = 8, height = 6)
}


# Looping over species names and create map plots
lapply(species_of_interest, create_species_map)

```

## Animating the maps

```{r}
# Loading world data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Standardizing continent names in world data
world <- world %>%
  mutate(region_un = case_when(
    region_un %in% c("Asia", "Oceania", "South America", "North America", "Africa", "Europe") ~ region_un,
    TRUE ~ "Other"
  ))

# Function to create a map plot for a species
create_species_map <- function(species_name) {
  # Reading the corresponding EAC CSV file
  species_result <- read.csv(file.path("../EAC_ingredients/EAC/", paste0(gsub(" ", "_", species_name), "_EAC.csv")))
  
  # Ordering the data frame by EarliestAppearance in ascending order
  species_result <- species_result %>% arrange(earliest_year)
  
  # Getting the order of continents based on the first appearance year
  continent_order <- species_result %>%
    group_by(continent) %>%
    summarize(first_appearance = min(earliest_year)) %>%
    arrange(first_appearance) %>%
    pull(continent)
  
  # Defining custom order for y-axis
  custom_order <- continent_order
  
  # Creating a factor variable for Continent with the custom order
  species_result$continent <- factor(species_result$continent, levels = custom_order)
  
  # Merging species_result data frame with continent boundaries
  merged_data <- merge(world, species_result, by.x = "continent", by.y = "continent")
  
  # Creating the map
  map_plot  <-  ggplot() +
      borders("world", colour = "gray85", fill = "gray80") +
      geom_sf(data = merged_data,aes(fill = earliest_year)) +
      scale_fill_viridis_c() +
      labs(title = paste(species_name),
           fill = "Year of First \nAppearance") +
      theme_minimal() +
      theme(plot.background = element_rect(fill = "white"),
            legend.background=element_blank(),
            axis.title=element_blank(),
            legend.key.size = unit(0.6, 'cm'),
            legend.title=element_text(size=9), 
            legend.text=element_text(size=8)) +
      coord_sf(label_axes = "both")
  
  # Printing the map plot
  print(map_plot)
  
  # Creating a folder for each species
  species_folder <- paste0("../EAC_ingredients/maps/EAC_", gsub(" ", "_", gsub("\\.", "", species_name)), "/")
  dir.create(species_folder, showWarnings = FALSE)
  
  # Saving the map plot
  ggsave(paste0(species_folder, "earliest_appearance.png"), plot = map_plot, width = 8, height = 6)
  
  # Animating the map
  animated_map  <-  map_plot +
   transition_manual(frames=earliest_year,cumulative = TRUE) +
   labs(title = paste(species_name),
          subtitle = 'Year: {current_frame}')
  
  # Printing the map plot
  print(animated_map)
  
  # Saving the map plot
  anim_save(paste0(species_folder, "annimated_map.gif"), plot = animated_map, width = 8, height = 6)
  
}

# Looping over species names and create map plots
lapply(species_of_interest, create_species_map)


```
